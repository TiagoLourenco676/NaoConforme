<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#1e40af">
    <meta name="description" content="Sistema de Controle e Monitoramento de Não Conformidades">
    <title>Sistema de Não Conformidades</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', sans-serif;
            background: #f1f3f9;
            color: #1e293b;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #60a5fa 100%);
            color: white;
            padding: 2rem 0;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-container {
            max-width: 1400px;
            margin: -1rem auto 2rem;
            padding: 0 2rem;
            position: relative;
            z-index: 10;
        }

        .tab-navigation {
            display: flex;
            background: white;
            border-radius: 12px 12px 0 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .tab-button {
            flex: 1;
            padding: 1.25rem 1rem;
            background: #f8fafc;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: #64748b;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(0,0,0,0.1);
        }

        .tab-button.active {
            background: white;
            color: #1e40af;
            border-bottom-color: #1e40af;
            transform: translateY(-2px);
        }

        .tab-button:hover {
            background: #e2e8f0;
            color: #334155;
        }

        .tab-content {
            background: white;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            min-height: 70vh;
        }

        .tab-panel {
            display: none;
            padding: 2rem;
        }

        .tab-panel.active {
            display: block;
        }

        /* Seção de Registro */
        .register-section {
            max-width: 900px;
            margin: 0 auto;
        }

        .register-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .register-header h2 {
            color: #1e293b;
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .register-header p {
            color: #64748b;
        }

        .form-layout {
            display: grid;
            gap: 1.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .form-field {
            position: relative;
        }

        .form-field label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }

        .form-field input,
        .form-field select,
        .form-field textarea {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s ease;
            background: #fafbfc;
        }

        .form-field input:focus,
        .form-field select:focus,
        .form-field textarea:focus {
            outline: none;
            border-color: #3b82f6;
            background: white;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-field textarea {
            resize: vertical;
            min-height: 100px;
        }

        .upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8fafc;
        }

        .upload-area:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }

        .upload-area input {
            display: none;
        }

        .upload-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: #64748b;
        }

        .submit-button {
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(0,0,0,0.1);
        }

        .submit-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
        }

        /* Seção de Análise */
        .analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .analysis-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1e293b;
        }

        .action-buttons {
            display: flex;
            gap: 0.75rem;
        }

        .action-btn {
            padding: 0.625rem 1rem;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(0,0,0,0.1);
        }

        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-danger { background: #ef4444; color: white; }

        .action-btn:hover {
            transform: translateY(-1px);
            filter: brightness(110%);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #64748b;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .data-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .table-header {
            background: #f1f5f9;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .table-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
        }

        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f8fafc;
            padding: 1rem 1.5rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
        }

        td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #f1f5f9;
        }

        tr:hover {
            background: #f8fafc;
        }

        /* Seção de Registros */
        .records-header {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .records-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1e293b;
        }

        .record-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }

        .record-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #f1f5f9;
        }

        .record-id {
            font-weight: 700;
            color: #1e40af;
            font-size: 1.1rem;
        }

        .record-date {
            color: #64748b;
            font-size: 0.875rem;
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-fornecedor {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-interno {
            background: #dbeafe;
            color: #1e40af;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #64748b;
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Estilos para sugestões */
        .suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .suggestion-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
            transition: background-color 0.2s ease;
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(0,0,0,0.1);
        }

        .suggestion-item:hover {
            background: #f8fafc;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            text-align: center;
        }

        .modal h3 {
            color: #ef4444;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        .modal-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(0,0,0,0.1);
        }

        .modal-btn-confirm {
            background: #ef4444;
            color: white;
        }

        .modal-btn-cancel {
            background: #6b7280;
            color: white;
        }

        .progress-bar {
            background: #e5e7eb;
            border-radius: 4px;
            height: 6px;
            overflow: hidden;
            margin: 0.5rem 0;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-primary { background: #3b82f6; }
        .progress-warning { background: #f59e0b; }

        /* Responsivo Mobile */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }

            .header p {
                font-size: 1rem;
            }

            .main-container {
                padding: 0 0.5rem;
                margin-top: -0.5rem;
            }

            .tab-navigation {
                flex-direction: column;
                border-radius: 8px;
            }

            .tab-button {
                padding: 1rem 0.75rem;
                font-size: 0.9rem;
                border-bottom: 1px solid #e2e8f0;
                border-radius: 0;
            }

            .tab-button:last-child {
                border-bottom: none;
            }

            .tab-button.active {
                transform: none;
                border-bottom: 1px solid #e2e8f0;
                border-left: 4px solid #1e40af;
            }

            .tab-content {
                border-radius: 0 0 8px 8px;
            }

            .tab-panel {
                padding: 1rem;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .form-field input,
            .form-field select,
            .form-field textarea {
                padding: 1rem;
                font-size: 16px;
            }

            .form-field input:focus,
            .form-field select:focus,
            .form-field textarea:focus {
                transform: scale(1.02);
                transition: transform 0.1s ease;
            }

            .upload-area {
                padding: 1.5rem 1rem;
            }

            .submit-button {
                width: 100%;
                padding: 1.25rem;
                font-size: 1.1rem;
                margin-top: 1rem;
            }

            .analysis-header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            .analysis-title {
                font-size: 1.5rem;
                text-align: center;
            }

            .action-buttons {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }

            .action-btn {
                padding: 0.875rem 0.5rem;
                font-size: 0.8rem;
                justify-content: center;
                text-align: center;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }

            .stat-card {
                padding: 1rem;
            }

            .stat-number {
                font-size: 1.5rem;
            }

            .stat-label {
                font-size: 0.8rem;
            }

            .data-table {
                margin-bottom: 1rem;
            }

            .table-header {
                padding: 1rem;
            }

            .table-title {
                font-size: 1.1rem;
            }

            .table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            table {
                min-width: 600px;
            }

            th, td {
                padding: 0.75rem 0.5rem;
                font-size: 0.8rem;
                white-space: nowrap;
            }

            th:first-child,
            td:first-child {
                position: sticky;
                left: 0;
                background: inherit;
                z-index: 1;
                box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            }

            .record-card {
                padding: 1rem;
                margin-bottom: 0.75rem;
            }

            .record-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .record-id {
                font-size: 1rem;
            }

            .record-date {
                font-size: 0.8rem;
            }

            .badge {
                padding: 0.25rem 0.5rem;
                font-size: 0.7rem;
                margin: 0.25rem 0;
            }

            .register-header h2 {
                font-size: 1.5rem;
            }

            .records-title {
                font-size: 1.5rem;
            }

            .suggestions {
                max-height: 150px;
                font-size: 0.9rem;
            }

            .suggestion-item {
                padding: 0.75rem;
            }

            .modal-content {
                margin: 10% auto;
                padding: 1.5rem;
                width: 95%;
                max-width: none;
            }

            .modal h3 {
                font-size: 1.3rem;
            }

            .modal-buttons {
                flex-direction: column;
                gap: 0.75rem;
            }

            .modal-btn {
                padding: 1rem;
                font-size: 1rem;
            }

            #imageModal img {
                width: 95%;
                max-width: none;
            }

            .empty-state {
                padding: 2rem 1rem;
            }

            .empty-icon {
                font-size: 3rem;
            }

            #imagePreview {
                justify-content: center;
            }

            #imagePreview img {
                width: 70px;
                height: 70px;
            }

            .register-section {
                max-width: 100%;
            }

            .form-layout {
                gap: 1.25rem;
            }
        }

        /* Ultra pequenas (portrait) */
        @media (max-width: 480px) {
            .header {
                padding: 1.5rem 0;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .header p {
                font-size: 0.9rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                grid-template-columns: 1fr;
            }

            .action-btn {
                padding: 1rem;
                font-size: 0.9rem;
            }

            table {
                min-width: 500px;
            }

            th, td {
                padding: 0.5rem 0.25rem;
                font-size: 0.75rem;
            }

            .form-field input,
            .form-field select,
            .form-field textarea {
                padding: 1.25rem 1rem;
            }
        }

        /* Paisagem mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .header {
                padding: 1rem 0;
            }

            .header h1 {
                font-size: 1.6rem;
            }

            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .action-buttons {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Dark mode */
        @media (prefers-color-scheme: dark) {
            body {
                background: #0f172a;
                color: #e2e8f0;
            }

            .tab-content,
            .record-card,
            .stat-card,
            .data-table {
                background: #1e293b;
                border-color: #334155;
            }

            .form-field input,
            .form-field select,
            .form-field textarea {
                background: #334155;
                border-color: #475569;
                color: #e2e8f0;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <h1>🔍 Sistema de Não Conformidades</h1>
            <p>Controle e Monitoramento de Qualidade</p>
        </div>
    </header>

    <div class="main-container">
        <nav class="tab-navigation">
            <button class="tab-button active" onclick="showTab('register')">
                📝 Registrar Não Conformidade
            </button>
            <button class="tab-button" onclick="showTab('analysis')">
                📊 Análise de Dados
            </button>
            <button class="tab-button" onclick="showTab('records')">
                📋 Histórico de Registros
            </button>
        </nav>

        <div class="tab-content">
            <!-- Tab: Registrar -->
            <div id="register" class="tab-panel active">
                <div class="register-section">
                    <div class="register-header">
                        <h2>Nova Não Conformidade</h2>
                        <p>Preencha as informações abaixo para registrar uma nova não conformidade</p>
                    </div>

                    <form id="productForm" class="form-layout">
                        <div class="form-row">
                            <div class="form-field">
                                <label for="productCode">Código do Produto *</label>
                                <div style="position: relative;">
                                    <input type="text" id="productCode" name="productCode" required 
                                           placeholder="Ex: PRD-001-2024" autocomplete="off">
                                    <div id="productSuggestions" class="suggestions"></div>
                                </div>
                            </div>

                            <div class="form-field">
                                <label for="quantity">Quantidade Afetada *</label>
                                <input type="number" id="quantity" name="quantity" required 
                                       min="1" placeholder="Ex: 50" value="1">
                            </div>

                            <div class="form-field">
                                <label for="origin">Procedência *</label>
                                <select id="origin" name="origin" required onchange="toggleSupplierField()">
                                    <option value="">Selecione a procedência</option>
                                    <option value="fornecedor">Fornecedor</option>
                                    <option value="interno">Interno</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row" id="supplierRow" style="display: none;">
                            <div class="form-field">
                                <label for="supplierName">Nome do Fornecedor *</label>
                                <div style="position: relative;">
                                    <input type="text" id="supplierName" name="supplierName" 
                                           placeholder="Ex: ABC Componentes Ltda." autocomplete="off">
                                    <div id="supplierSuggestions" class="suggestions"></div>
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-field">
                                <label for="productDescription">Descrição do Item *</label>
                                <div style="position: relative;">
                                    <input type="text" id="productDescription" name="productDescription" required 
                                           placeholder="Ex: Parafuso M8 x 20mm" autocomplete="off">
                                    <div id="descriptionSuggestions" class="suggestions"></div>
                                </div>
                            </div>
                        </div>

                        <div class="form-field">
                            <label for="defectCause">Causa do Defeito *</label>
                            <div style="position: relative;">
                                <textarea id="defectCause" name="defectCause" required 
                                          placeholder="Descreva detalhadamente a causa do defeito encontrado..." 
                                          autocomplete="off"></textarea>
                                <div id="defectSuggestions" class="suggestions"></div>
                            </div>
                        </div>

                        <div class="form-field">
                            <label>Imagens do Defeito</label>
                            <div class="upload-area" onclick="document.getElementById('images').click()">
                                <input type="file" id="images" name="images" multiple accept="image/*">
                                <div class="upload-icon">📷</div>
                                <div>Clique para adicionar imagens</div>
                                <small>Múltiplas imagens permitidas (JPG, PNG)</small>
                            </div>
                            <div id="imagePreview" style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;"></div>
                        </div>

                        <div style="text-align: center; margin-top: 2rem;">
                            <button type="submit" class="submit-button">
                                ✅ Registrar Não Conformidade
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tab: Análise -->
            <div id="analysis" class="tab-panel">
                <div class="analysis-header">
                    <h2 class="analysis-title">Análise de Dados</h2>
                    <div class="action-buttons">
                        <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="loadData(event)">
                        <button onclick="document.getElementById('fileInput').click()" class="action-btn btn-primary">
                            📁 Carregar
                        </button>
                        <button onclick="exportData()" class="action-btn btn-success">
                            💾 Salvar
                        </button>
                        <button onclick="generatePDFReport()" class="action-btn btn-warning">
                            📄 PDF
                        </button>
                        <button onclick="confirmClearRecords()" class="action-btn btn-danger">
                            🗑️ Limpar
                        </button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalRecords">0</div>
                        <div class="stat-label">Total de Registros</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="uniqueProducts">0</div>
                        <div class="stat-label">Produtos Únicos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalQuantity">0</div>
                        <div class="stat-label">Unidades Afetadas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="supplierIssues">0</div>
                        <div class="stat-label">Problemas Fornecedor</div>
                    </div>
                </div>

                <div class="data-table">
                    <div class="table-header">
                        <h3 class="table-title">📦 Análise por Produto</h3>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Código</th>
                                    <th>Descrição</th>
                                    <th>Quantidade</th>
                                    <th>Registros</th>
                                    <th>Procedência</th>
                                    <th>Fornecedores</th>
                                </tr>
                            </thead>
                            <tbody id="productTableBody">
                                <tr>
                                    <td colspan="6" class="empty-state">
                                        <div class="empty-icon">📦</div>
                                        Nenhum produto registrado ainda
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="data-table">
                    <div class="table-header">
                        <h3 class="table-title">⚠️ Análise por Tipo de Defeito</h3>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Categoria</th>
                                    <th>Ocorrências</th>
                                    <th>Quantidade Afetada</th>
                                    <th>Participação</th>
                                </tr>
                            </thead>
                            <tbody id="defectTableBody">
                                <tr>
                                    <td colspan="4" class="empty-state">
                                        <div class="empty-icon">⚠️</div>
                                        Nenhum defeito registrado ainda
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tab: Registros -->
            <div id="records" class="tab-panel">
                <div class="records-header">
                    <h2 class="records-title">Histórico de Registros</h2>
                </div>
                
                <div id="recordsList">
                    <div class="empty-state">
                        <div class="empty-icon">📊</div>
                        <h3>Nenhum registro encontrado</h3>
                        <p>Registre a primeira não conformidade na aba "Registrar"</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmação -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h3>⚠️ Confirmar Exclusão</h3>
            <p>Tem certeza que deseja limpar todos os registros?<br>
            <strong>Esta ação não pode ser desfeita!</strong></p>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeConfirmModal()">
                    Cancelar
                </button>
                <button class="modal-btn modal-btn-confirm" onclick="clearAllRecords()">
                    Sim, Limpar Tudo
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para visualizar imagens -->
    <div id="imageModal" class="modal">
        <span style="position: absolute; top: 15px; right: 35px; color: white; font-size: 40px; cursor: pointer;" onclick="closeImageModal()">&times;</span>
        <img id="modalImage" style="margin: auto; display: block; width: 80%; max-width: 700px; border-radius: 10px;">
    </div>

    <script>
        // Array para armazenar os registros
        let records = [];
        let currentImages = [];
        let savedProductCodes = [];
        let savedDescriptions = [];
        let savedDefects = [];
        let savedSuppliers = [];

        // Elementos do DOM
        const form = document.getElementById('productForm');
        const recordsList = document.getElementById('recordsList');
        const imagesInput = document.getElementById('images');
        const imagePreview = document.getElementById('imagePreview');
        const productCodeInput = document.getElementById('productCode');
        const productSuggestions = document.getElementById('productSuggestions');
        const productDescriptionInput = document.getElementById('productDescription');
        const descriptionSuggestions = document.getElementById('descriptionSuggestions');
        const defectCauseInput = document.getElementById('defectCause');
        const defectSuggestions = document.getElementById('defectSuggestions');
        const supplierNameInput = document.getElementById('supplierName');
        const supplierSuggestions = document.getElementById('supplierSuggestions');
        const confirmModal = document.getElementById('confirmModal');
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');

        // Função para alternar abas
        function showTab(tabName) {
            // Remove active de todos os botões e painéis
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
            
            // Adiciona active ao botão e painel corretos
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            // Scroll suave para o topo do conteúdo em mobile
            if (window.innerWidth <= 768) {
                document.querySelector('.tab-content').scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
            }
            
            // Atualiza dados se for a aba de análise
            if (tabName === 'analysis') {
                updateDashboard();
            }
        }

        // Detecta se é dispositivo touch
        function isTouchDevice() {
            return ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
        }

        // Event listeners
        form.addEventListener('submit', handleSubmit);
        imagesInput.addEventListener('change', handleImageChange);
        productCodeInput.addEventListener('input', handleProductCodeInput);
        productCodeInput.addEventListener('focus', showProductSuggestions);
        productCodeInput.addEventListener('blur', hideProductSuggestions);
        productDescriptionInput.addEventListener('input', handleDescriptionInput);
        productDescriptionInput.addEventListener('focus', showDescriptionSuggestions);
        productDescriptionInput.addEventListener('blur', hideDescriptionSuggestions);
        defectCauseInput.addEventListener('input', handleDefectInput);
        defectCauseInput.addEventListener('focus', showDefectSuggestions);
        defectCauseInput.addEventListener('blur', hideDefectSuggestions);
        supplierNameInput.addEventListener('input', handleSupplierInput);
        supplierNameInput.addEventListener('focus', showSupplierSuggestions);
        supplierNameInput.addEventListener('blur', hideSupplierSuggestions);

        // Função para mostrar/ocultar campo de fornecedor
        function toggleSupplierField() {
            const origin = document.getElementById('origin').value;
            const supplierRow = document.getElementById('supplierRow');
            const supplierNameInput = document.getElementById('supplierName');
            
            if (origin === 'fornecedor') {
                supplierRow.style.display = 'block';
                supplierNameInput.required = true;
            } else {
                supplierRow.style.display = 'none';
                supplierNameInput.required = false;
                supplierNameInput.value = '';
            }
        }

        // Melhora a experiência de upload em mobile
        function handleImageChange(e) {
            const files = Array.from(e.target.files);
            currentImages = [];
            imagePreview.innerHTML = '';

            if (files.length > 5 && window.innerWidth <= 768) {
                alert('Para melhor performance no mobile, recomendamos até 5 imagens por registro.');
            }

            files.slice(0, 8).forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        currentImages.push(e.target.result);
                        
                        const imgContainer = document.createElement('div');
                        imgContainer.style.position = 'relative';
                        imgContainer.style.display = 'inline-block';
                        
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.style.width = window.innerWidth <= 768 ? '70px' : '80px';
                        img.style.height = window.innerWidth <= 768 ? '70px' : '80px';
                        img.style.objectFit = 'cover';
                        img.style.borderRadius = '5px';
                        img.style.border = '2px solid #e5e7eb';
                        img.style.cursor = 'pointer';
                        img.onclick = () => openImageModal(e.target.result);
                        
                        if (window.innerWidth <= 768) {
                            img.style.transition = 'opacity 0.3s ease';
                            img.style.opacity = '0';
                            img.onload = () => { img.style.opacity = '1'; };
                        }
                        
                        imgContainer.appendChild(img);
                        imagePreview.appendChild(imgContainer);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // Sistema de sugestões
        function handleProductCodeInput(e) {
            const value = e.target.value.toLowerCase();
            const suggestions = savedProductCodes.filter(code => 
                code.toLowerCase().includes(value)
            );
            
            if (value.length > 0) {
                showFilteredSuggestions(suggestions, e.target.value);
            } else {
                showProductSuggestions();
            }
        }

        function showProductSuggestions() {
            if (savedProductCodes.length === 0) return;
            
            productSuggestions.innerHTML = savedProductCodes.map(code => `
                <div class="suggestion-item" onmousedown="selectProduct('${code}')">
                    ${code}
                </div>
            `).join('');
            
            productSuggestions.style.display = 'block';
        }

        function showFilteredSuggestions(suggestions, currentValue) {
            if (suggestions.length === 0) {
                productSuggestions.style.display = 'none';
                return;
            }

            productSuggestions.innerHTML = suggestions.map(code => `
                <div class="suggestion-item" onmousedown="selectProduct('${code}')">
                    ${code}
                </div>
            `).join('');
            
            if (!savedProductCodes.includes(currentValue) && currentValue.length > 0) {
                productSuggestions.innerHTML += `
                    <div class="suggestion-item" style="font-style: italic; color: #3b82f6;" onmousedown="selectProduct('${currentValue}')">
                        ➕ Novo: ${currentValue}
                    </div>
                `;
            }
            
            productSuggestions.style.display = 'block';
        }

        function hideProductSuggestions() {
            setTimeout(() => {
                productSuggestions.style.display = 'none';
            }, 200);
        }

        function selectProduct(code) {
            productCodeInput.value = code;
            productSuggestions.style.display = 'none';
        }

        // Funções similares para descrição e defeito
        function handleDescriptionInput(e) {
            const value = e.target.value.toLowerCase();
            const suggestions = savedDescriptions.filter(desc => 
                desc.toLowerCase().includes(value)
            );
            
            if (value.length > 0) {
                showFilteredDescriptions(suggestions, e.target.value);
            } else {
                showDescriptionSuggestions();
            }
        }

        function showDescriptionSuggestions() {
            if (savedDescriptions.length === 0) return;
            
            descriptionSuggestions.innerHTML = savedDescriptions.map(desc => `
                <div class="suggestion-item" onmousedown="selectDescription('${desc}')">
                    ${desc}
                </div>
            `).join('');
            
            descriptionSuggestions.style.display = 'block';
        }

        function showFilteredDescriptions(suggestions, currentValue) {
            if (suggestions.length === 0) {
                descriptionSuggestions.style.display = 'none';
                return;
            }

            descriptionSuggestions.innerHTML = suggestions.map(desc => `
                <div class="suggestion-item" onmousedown="selectDescription('${desc}')">
                    ${desc}
                </div>
            `).join('');
            
            if (!savedDescriptions.includes(currentValue) && currentValue.length > 0) {
                descriptionSuggestions.innerHTML += `
                    <div class="suggestion-item" style="font-style: italic; color: #3b82f6;" onmousedown="selectDescription('${currentValue}')">
                        ➕ Nova: ${currentValue}
                    </div>
                `;
            }
            
            descriptionSuggestions.style.display = 'block';
        }

        function hideDescriptionSuggestions() {
            setTimeout(() => {
                descriptionSuggestions.style.display = 'none';
            }, 200);
        }

        function selectDescription(desc) {
            productDescriptionInput.value = desc;
            descriptionSuggestions.style.display = 'none';
        }

        function handleDefectInput(e) {
            const value = e.target.value.toLowerCase();
            const suggestions = savedDefects.filter(defect => 
                defect.toLowerCase().includes(value)
            );
            
            if (value.length > 2) {
                showFilteredDefects(suggestions, e.target.value);
            } else {
                defectSuggestions.style.display = 'none';
            }
        }

        function showDefectSuggestions() {
            if (savedDefects.length === 0) return;
            
            defectSuggestions.innerHTML = savedDefects.slice(0, 5).map(defect => `
                <div class="suggestion-item" onmousedown="selectDefect('${defect}')">
                    ${defect}
                </div>
            `).join('');
            
            defectSuggestions.style.display = 'block';
        }

        function showFilteredDefects(suggestions, currentValue) {
            if (suggestions.length === 0) {
                defectSuggestions.style.display = 'none';
                return;
            }

            defectSuggestions.innerHTML = suggestions.slice(0, 5).map(defect => `
                <div class="suggestion-item" onmousedown="selectDefect('${defect}')">
                    ${defect}
                </div>
            `).join('');
            
            defectSuggestions.style.display = 'block';
        }

        function hideDefectSuggestions() {
            setTimeout(() => {
                defectSuggestions.style.display = 'none';
            }, 200);
        }

        function selectDefect(defect) {
            defectCauseInput.value = defect;
            defectSuggestions.style.display = 'none';
        }

        // Funções de sugestão para fornecedor
        function handleSupplierInput(e) {
            const value = e.target.value.toLowerCase();
            const suggestions = savedSuppliers.filter(supplier => 
                supplier.toLowerCase().includes(value)
            );
            
            if (value.length > 0) {
                showFilteredSuppliers(suggestions, e.target.value);
            } else {
                showSupplierSuggestions();
            }
        }

        function showSupplierSuggestions() {
            if (savedSuppliers.length === 0) return;
            
            supplierSuggestions.innerHTML = savedSuppliers.map(supplier => `
                <div class="suggestion-item" onmousedown="selectSupplier('${supplier}')">
                    ${supplier}
                </div>
            `).join('');
            
            supplierSuggestions.style.display = 'block';
        }

        function showFilteredSuppliers(suggestions, currentValue) {
            if (suggestions.length === 0) {
                supplierSuggestions.style.display = 'none';
                return;
            }

            supplierSuggestions.innerHTML = suggestions.map(supplier => `
                <div class="suggestion-item" onmousedown="selectSupplier('${supplier}')">
                    ${supplier}
                </div>
            `).join('');
            
            if (!savedSuppliers.includes(currentValue) && currentValue.length > 0) {
                supplierSuggestions.innerHTML += `
                    <div class="suggestion-item" style="font-style: italic; color: #3b82f6;" onmousedown="selectSupplier('${currentValue}')">
                        ➕ Novo: ${currentValue}
                    </div>
                `;
            }
            
            supplierSuggestions.style.display = 'block';
        }

        function hideSupplierSuggestions() {
            setTimeout(() => {
                supplierSuggestions.style.display = 'none';
            }, 200);
        }

        function selectSupplier(supplier) {
            supplierNameInput.value = supplier;
            supplierSuggestions.style.display = 'none';
        }

        function saveProductCode(code) {
            if (code && !savedProductCodes.includes(code)) {
                savedProductCodes.push(code);
            }
        }

        function saveDescription(description) {
            if (description && !savedDescriptions.includes(description)) {
                savedDescriptions.push(description);
            }
        }

        function saveDefect(defect) {
            if (defect && !savedDefects.includes(defect)) {
                savedDefects.push(defect);
            }
        }

        function saveSupplier(supplier) {
            if (supplier && !savedSuppliers.includes(supplier)) {
                savedSuppliers.push(supplier);
            }
        }

        function handleSubmit(e) {
            e.preventDefault();

            const formData = new FormData(form);
            const productCode = formData.get('productCode');
            const productDescription = formData.get('productDescription');
            const defectCause = formData.get('defectCause');
            const origin = formData.get('origin');
            const supplierName = formData.get('supplierName');
            
            // Validação específica para fornecedor
            if (origin === 'fornecedor' && !supplierName) {
                alert('O nome do fornecedor é obrigatório quando a procedência for "Fornecedor"');
                return;
            }
            
            const record = {
                id: generateId(),
                productCode: productCode,
                productDescription: productDescription,
                quantity: parseInt(formData.get('quantity')),
                origin: origin,
                supplierName: origin === 'fornecedor' ? supplierName : null,
                defectCause: defectCause,
                images: [...currentImages],
                date: new Date().toLocaleString('pt-BR')
            };

            // Salva os dados para uso futuro
            saveProductCode(productCode);
            saveDescription(productDescription);
            saveDefect(defectCause);
            if (origin === 'fornecedor' && supplierName) {
                saveSupplier(supplierName);
            }

            records.unshift(record);
            renderRecords();
            form.reset();
            currentImages = [];
            imagePreview.innerHTML = '';
            toggleSupplierField();

            // Feedback visual
            const submitBtn = form.querySelector('.submit-button');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '✅ Registrado com sucesso!';
            submitBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
            
            setTimeout(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.style.background = 'linear-gradient(135deg, #3b82f6, #1e40af)';
            }, 2000);
        }

        function generateId() {
            return 'NC-' + Date.now().toString().slice(-6);
        }

        function renderRecords() {
            updateDashboard();
            
            if (records.length === 0) {
                recordsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">📊</div>
                        <h3>Nenhum registro encontrado</h3>
                        <p>Registre a primeira não conformidade na aba "Registrar"</p>
                    </div>
                `;
                return;
            }

            const isMobile = window.innerWidth <= 768;
            const recordsToShow = isMobile ? Math.min(records.length, 10) : records.length;
            const recordsToRender = records.slice(0, recordsToShow);

            recordsList.innerHTML = recordsToRender.map(record => `
                <div class="record-card">
                    <div class="record-header">
                        <div class="record-id">${record.id}</div>
                        <div class="record-date">${record.date}</div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(${isMobile ? '180px' : '200px'}, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <strong>Produto:</strong> ${record.productCode}<br>
                            <small style="color: #64748b;">${record.productDescription}</small>
                        </div>
                        <div>
                            <strong>Quantidade:</strong> ${record.quantity} unidades
                        </div>
                        <div>
                            <strong>Procedência:</strong> 
                            <span class="badge badge-${record.origin}">
                                ${record.origin.charAt(0).toUpperCase() + record.origin.slice(1)}
                            </span>
                            ${record.supplierName ? `<br><small style="color: #64748b; margin-top: 0.25rem; display: block;"><strong>Fornecedor:</strong> ${record.supplierName}</small>` : ''}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <strong>Causa do Defeito:</strong><br>
                        <div style="margin-top: 0.5rem; color: #374151;">${record.defectCause}</div>
                    </div>
                    
                    ${record.images.length > 0 ? `
                        <div>
                            <strong>Imagens (${record.images.length}):</strong><br>
                            <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
                                ${record.images.slice(0, isMobile ? 4 : 8).map((img, index) => `
                                    <img src="${img}" 
                                         style="width: ${isMobile ? '50px' : '60px'}; height: ${isMobile ? '50px' : '60px'}; object-fit: cover; border-radius: 5px; cursor: pointer; border: 2px solid #e5e7eb;" 
                                         onclick="openImageModal('${img}')" 
                                         alt="Imagem do defeito"
                                         loading="lazy">
                                `).join('')}
                                ${record.images.length > (isMobile ? 4 : 8) ? `
                                    <div style="width: ${isMobile ? '50px' : '60px'}; height: ${isMobile ? '50px' : '60px'}; border-radius: 5px; border: 2px dashed #cbd5e1; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; color: #64748b; cursor: pointer;" onclick="alert('Mais ${record.images.length - (isMobile ? 4 : 8)} imagem(ns) disponível(eis)')">
                                        +${record.images.length - (isMobile ? 4 : 8)}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `).join('');

            if (isMobile && records.length > 10) {
                const loadMoreBtn = document.createElement('div');
                loadMoreBtn.style.textAlign = 'center';
                loadMoreBtn.style.marginTop = '1rem';
                loadMoreBtn.innerHTML = `
                    <button onclick="loadMoreRecords()" class="action-btn btn-primary" style="width: 100%; padding: 1rem;">
                        📄 Carregar mais registros (${records.length - 10} restantes)
                    </button>
                `;
                recordsList.appendChild(loadMoreBtn);
            }
        }

        function loadMoreRecords() {
            const currentShown = recordsList.querySelectorAll('.record-card').length;
            const nextBatch = records.slice(currentShown, currentShown + 10);
            
            nextBatch.forEach(record => {
                const recordDiv = document.createElement('div');
                recordDiv.className = 'record-card';
                recordDiv.innerHTML = `
                    <div class="record-header">
                        <div class="record-id">${record.id}</div>
                        <div class="record-date">${record.date}</div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <strong>Produto:</strong> ${record.productCode}<br>
                            <small style="color: #64748b;">${record.productDescription}</small>
                        </div>
                        <div>
                            <strong>Quantidade:</strong> ${record.quantity} unidades
                        </div>
                        <div>
                            <strong>Procedência:</strong> 
                            <span class="badge badge-${record.origin}">
                                ${record.origin.charAt(0).toUpperCase() + record.origin.slice(1)}
                            </span>
                            ${record.supplierName ? `<br><small style="color: #64748b; margin-top: 0.25rem; display: block;"><strong>Fornecedor:</strong> ${record.supplierName}</small>` : ''}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <strong>Causa do Defeito:</strong><br>
                        <div style="margin-top: 0.5rem; color: #374151;">${record.defectCause}</div>
                    </div>
                    
                    ${record.images.length > 0 ? `
                        <div>
                            <strong>Imagens (${record.images.length}):</strong><br>
                            <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
                                ${record.images.slice(0, 4).map(img => `
                                    <img src="${img}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px; cursor: pointer; border: 2px solid #e5e7eb;" onclick="openImageModal('${img}')" alt="Imagem do defeito" loading="lazy">
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                `;
                
                const oldBtn = recordsList.querySelector('button[onclick="loadMoreRecords()"]')?.parentElement;
                if (oldBtn) oldBtn.remove();
                
                recordsList.appendChild(recordDiv);
            });
            
            const remaining = records.length - (currentShown + nextBatch.length);
            if (remaining > 0) {
                const loadMoreBtn = document.createElement('div');
                loadMoreBtn.style.textAlign = 'center';
                loadMoreBtn.style.marginTop = '1rem';
                loadMoreBtn.innerHTML = `
                    <button onclick="loadMoreRecords()" class="action-btn btn-primary" style="width: 100%; padding: 1rem;">
                        📄 Carregar mais registros (${remaining} restantes)
                    </button>
                `;
                recordsList.appendChild(loadMoreBtn);
            }
        }

        function updateDashboard() {
            const totalRecords = records.length;
            const uniqueProducts = new Set(records.map(r => r.productCode)).size;
            const totalQuantity = records.reduce((sum, record) => sum + record.quantity, 0);
            const supplierIssues = records.filter(r => r.origin === 'fornecedor').length;
            const uniqueSuppliers = new Set(records.filter(r => r.supplierName).map(r => r.supplierName)).size;

            document.getElementById('totalRecords').textContent = totalRecords;
            document.getElementById('uniqueProducts').textContent = uniqueProducts;
            document.getElementById('totalQuantity').textContent = totalQuantity;
            document.getElementById('supplierIssues').textContent = `${supplierIssues} (${uniqueSuppliers} únicos)`;

            // Atualiza tabela de produtos
            const productData = {};
            records.forEach(record => {
                const key = record.productCode;
                if (!productData[key]) {
                    productData[key] = {
                        code: record.productCode,
                        description: record.productDescription,
                        totalQuantity: 0,
                        records: 0,
                        supplierCount: 0,
                        internalCount: 0,
                        suppliers: new Set()
                    };
                }
                
                productData[key].totalQuantity += record.quantity;
                productData[key].records++;
                
                if (record.origin === 'fornecedor') {
                    productData[key].supplierCount++;
                    if (record.supplierName) {
                        productData[key].suppliers.add(record.supplierName);
                    }
                } else {
                    productData[key].internalCount++;
                }
            });

            const productTableBody = document.getElementById('productTableBody');
            
            if (Object.keys(productData).length === 0) {
                productTableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <div class="empty-icon">📦</div>
                            Nenhum produto registrado ainda
                        </td>
                    </tr>
                `;
            } else {
                productTableBody.innerHTML = Object.values(productData)
                    .sort((a, b) => b.totalQuantity - a.totalQuantity)
                    .map(product => {
                        const suppliersList = Array.from(product.suppliers);
                        return `
                            <tr>
                                <td style="font-family: monospace; font-weight: 600;">${product.code}</td>
                                <td>${product.description}</td>
                                <td><strong>${product.totalQuantity}</strong></td>
                                <td><strong>${product.records}</strong></td>
                                <td>
                                    <div style="font-size: 0.875rem;">
                                        Fornecedor: <strong>${product.supplierCount}</strong><br>
                                        Interno: <strong>${product.internalCount}</strong>
                                    </div>
                                </td>
                                <td>
                                    <div style="font-size: 0.875rem;">
                                        ${suppliersList.length > 0 ? 
                                            suppliersList.map(supplier => `<span class="badge badge-fornecedor" style="margin: 2px; display: inline-block;">${supplier}</span>`).join('') 
                                            : '<span style="color: #9ca3af; font-style: italic;">N/A</span>'
                                        }
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('');
            }

            // Atualiza tabela de defeitos
            const defectCounts = {};
            records.forEach(record => {
                const category = categorizeDefect(record.defectCause);
                if (!defectCounts[category]) {
                    defectCounts[category] = { count: 0, quantity: 0 };
                }
                defectCounts[category].count++;
                defectCounts[category].quantity += record.quantity;
            });

            const defectTableBody = document.getElementById('defectTableBody');
            
            if (Object.keys(defectCounts).length === 0) {
                defectTableBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="empty-state">
                            <div class="empty-icon">⚠️</div>
                            Nenhum defeito registrado ainda
                        </td>
                    </tr>
                `;
            } else {
                defectTableBody.innerHTML = Object.entries(defectCounts)
                    .sort(([,a], [,b]) => b.count - a.count)
                    .map(([category, data]) => {
                        const percentage = Math.round((data.count / totalRecords) * 100);
                        return `
                            <tr>
                                <td><strong>${category}</strong></td>
                                <td><strong>${data.count}</strong></td>
                                <td><strong>${data.quantity}</strong></td>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="font-weight: 600;">${percentage}%</span>
                                        <div class="progress-bar" style="flex: 1;">
                                            <div class="progress-fill progress-primary" style="width: ${percentage}%"></div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('');
            }
        }

        function categorizeDefect(defectCause) {
            const defect = defectCause.toLowerCase();
            
            if (defect.includes('embalagem') || defect.includes('empacotamento')) {
                return 'Embalagem';
            } else if (defect.includes('soldagem') || defect.includes('solda')) {
                return 'Soldagem';
            } else if (defect.includes('riscos') || defect.includes('arranhões') || defect.includes('superficial')) {
                return 'Superficial';
            } else if (defect.includes('dimensional') || defect.includes('medida') || defect.includes('tamanho')) {
                return 'Dimensional';
            } else if (defect.includes('funcional') || defect.includes('operação') || defect.includes('funcionamento')) {
                return 'Funcional';
            } else if (defect.includes('material') || defect.includes('composição')) {
                return 'Material';
            }
            
            return 'Outros';
        }

        // Funções de exportação e importação
        function exportData() {
            if (records.length === 0) {
                alert('Não há dados para exportar!');
                return;
            }

            const exportObj = {
                metadata: {
                    exportDate: new Date().toISOString(),
                    totalRecords: records.length,
                    version: "1.0"
                },
                records: records,
                savedCodes: savedProductCodes,
                savedDescriptions: savedDescriptions,
                savedDefects: savedDefects,
                savedSuppliers: savedSuppliers
            };

            const dataStr = JSON.stringify(exportObj, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `nao_conformidades_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showNotification('✅ Dados exportados com sucesso!', 'success');
        }

        function loadData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.records && Array.isArray(data.records)) {
                        records = data.records;
                    } else if (Array.isArray(data)) {
                        records = data;
                    }

                    if (data.savedCodes) savedProductCodes = data.savedCodes;
                    if (data.savedDescriptions) savedDescriptions = data.savedDescriptions;
                    if (data.savedDefects) savedDefects = data.savedDefects;
                    if (data.savedSuppliers) savedSuppliers = data.savedSuppliers;

                    renderRecords();
                    showNotification('✅ Dados carregados com sucesso!', 'success');
                    
                } catch (error) {
                    alert('Erro ao carregar arquivo: Formato inválido');
                    console.error('Erro:', error);
                }
            };
            
            reader.readAsText(file);
            event.target.value = '';
        }

        function generatePDFReport() {
            if (records.length === 0) {
                alert('Não há dados para gerar relatório!');
                return;
            }

            showNotification('⏳ Gerando relatório...', 'info');
            
            setTimeout(() => {
                const reportHTML = generateReportHTML();
                const printWindow = window.open('', '_blank');
                printWindow.document.write(reportHTML);
                printWindow.document.close();
                
                printWindow.onload = function() {
                    printWindow.print();
                };
                
                showNotification('✅ Relatório gerado!', 'success');
            }, 1000);
        }

        function generateReportHTML() {
            const currentDate = new Date().toLocaleString('pt-BR');
            const currentDateOnly = new Date().toLocaleDateString('pt-BR');
            const totalRecords = records.length;
            const totalQuantity = records.reduce((sum, record) => sum + record.quantity, 0);
            const uniqueProducts = new Set(records.map(r => r.productCode)).size;
            
            return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Relatório de Não Conformidades</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            color: #333; 
            line-height: 1.4;
        }
        
        .document-header {
            background: #2563eb;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
        }
        
        .company-logo {
            height: 45px;
            width: auto;
        }
        
        .header-title {
            font-size: 1.3rem;
            font-weight: 600;
            text-align: center;
            flex: 1;
            margin: 0 20px;
        }
        
        .header-date {
            font-size: 0.9rem;
            color: #e2e8f0;
            text-align: right;
        }
        
        .main-title {
            background: #f7fafc;
            padding: 25px 30px;
            margin: 0;
            border-bottom: 3px solid #2563eb;
        }
        
        .main-title h1 {
            color: #1e293b;
            font-size: 2.2rem;
            font-weight: 700;
            margin: 0;
            text-align: center;
        }
        
        .report-info {
            background: #f9f9f9;
            padding: 25px 30px;
            margin: 0 0 30px 0;
            border: 1px solid #e2e8f0;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .info-item {
            display: flex;
            margin-bottom: 8px;
        }
        
        .info-label {
            font-weight: 600;
            color: #2563eb;
            min-width: 140px;
            margin-right: 10px;
        }
        
        .info-value {
            color: #2d3748;
            flex: 1;
        }
        
        .content-body {
            padding: 0 30px;
        }
        
        .summary { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        .summary-card { 
            text-align: center; 
            padding: 15px; 
            background: linear-gradient(135deg, #e6fffa, #b2f5ea); 
            border-radius: 8px; 
            border: 1px solid #81e6d9;
        }
        .summary-number { 
            font-size: 2rem; 
            font-weight: bold; 
            color: #234e52; 
        }
        .summary-label { 
            font-size: 0.9rem; 
            color: #2c7a7b; 
            font-weight: 600;
        }
        .records-section {
            margin-top: 30px;
        }
        .record-item {
            margin-bottom: 40px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #fafbfc;
            page-break-inside: avoid;
        }
        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e2e8f0;
        }
        .record-id {
            font-weight: bold;
            font-size: 1.2rem;
            color: #2563eb;
        }
        .record-date {
            color: #64748b;
            font-size: 0.9rem;
        }
        .record-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        .info-card {
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }
        .card-label {
            font-weight: 600;
            color: #374151;
            font-size: 0.85rem;
            margin-bottom: 5px;
        }
        .card-value {
            color: #1f2937;
        }
        .product-code {
            font-family: 'Courier New', monospace;
            background: #f3f4f6;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
        }
        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
        }
        .badge-fornecedor {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }
        .badge-interno {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #3b82f6;
        }
        .defect-description {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            margin: 15px 0;
        }
        .defect-title {
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }
        .images-section {
            margin-top: 15px;
        }
        .images-title {
            font-weight: 600;
            color: #374151;
            margin-bottom: 10px;
        }
        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        .image-container {
            text-align: center;
            page-break-inside: avoid;
        }
        .defect-image {
            width: 100%;
            max-width: 200px;
            height: auto;
            max-height: 150px;
            object-fit: cover;
            border-radius: 6px;
            border: 2px solid #e5e7eb;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .image-caption {
            margin-top: 5px;
            font-size: 0.8rem;
            color: #64748b;
        }
        .no-images {
            color: #9ca3af;
            font-style: italic;
            font-size: 0.9rem;
        }
        .page-break {
            page-break-before: always;
        }
        .footer {
            margin-top: 40px; 
            padding: 20px 30px; 
            border-top: 2px solid #e5e7eb; 
            text-align: center; 
            color: #64748b; 
            font-size: 0.9rem;
            background: #f9fafb;
        }
        
        @media print { 
            body { 
                margin: 0; 
                font-size: 12px;
            }
            .summary {
                grid-template-columns: repeat(2, 1fr);
            }
            .record-item {
                margin-bottom: 30px;
                page-break-inside: avoid;
            }
            .images-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .defect-image {
                max-height: 120px;
            }
        }
        @page {
            margin: 1cm;
        }
    </style>
</head>
<body>
    <div class="document-header">
        <div class="logo-section">
            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjQ1IiB2aWV3Qm94PSIwIDAgMTIwIDQ1IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB3aWR0aD0iMTIwIiBoZWlnaHQ9IjQ1IiByeD0iNCIgZmlsbD0iI0ZGRkZGRiIvPgo8cGF0aCBkPSJNMTAuNSAxNS41TDE1IDIwTDI0IDExIiBzdHJva2U9IiMyNTYzRUIiIHN0cm9rZS13aWR0aD0iMi41IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPHRleHQgeD0iMzgiIHk9IjE2IiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTAiIGZvbnQtd2VpZ2h0PSI3MDAiIGZpbGw9IiMyNTYzRUIiPkFEVkFOQ0VEIExBQlM8L3RleHQ+Cjx0ZXh0IHg9IjM4IiB5PSIyOCIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjgiIGZpbGw9IiM2Mzc0OEIiPjU4LjI5MS4yNDQvMDAwMS01MDwvdGV4dD4KPC9zdmc+" alt="Advanced Labs Logo" class="company-logo">
        </div>
        <div class="header-title">
            Relatório de Não Conformidades
        </div>
        <div class="header-date">
            ${currentDateOnly}
        </div>
    </div>

    <div class="main-title">
        <h1>Relatório de Não Conformidades</h1>
    </div>

    <div class="report-info">
        <div class="info-grid">
            <div>
                <div class="info-item">
                    <span class="info-label">Sistema:</span>
                    <span class="info-value">Controle de Qualidade</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Versão:</span>
                    <span class="info-value">2.0</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Período:</span>
                    <span class="info-value">${records.length > 0 ? `${records[records.length - 1].date.split(' ')[0]} a ${records[0].date.split(' ')[0]}` : 'N/A'}</span>
                </div>
            </div>
            <div>
                <div class="info-item">
                    <span class="info-label">Data/Hora Geração:</span>
                    <span class="info-value">${currentDate}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Total de Registros:</span>
                    <span class="info-value"><strong>${totalRecords}</strong></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Status:</span>
                    <span class="info-value">Documento Oficial</span>
                </div>
            </div>
        </div>
    </div>

    <div class="content-body">
        <div class="summary">
            <div class="summary-card">
                <div class="summary-number">${totalRecords}</div>
                <div class="summary-label">Total de Registros</div>
            </div>
            <div class="summary-card">
                <div class="summary-number">${uniqueProducts}</div>
                <div class="summary-label">Produtos Únicos</div>
            </div>
            <div class="summary-card">
                <div class="summary-number">${totalQuantity}</div>
                <div class="summary-label">Unidades Afetadas</div>
            </div>
            <div class="summary-card">
                <div class="summary-number">${records.filter(r => r.origin === 'fornecedor').length}</div>
                <div class="summary-label">Problemas Fornecedor</div>
            </div>
        </div>

        <div class="records-section">
            <h2 style="color: #1e293b; border-bottom: 2px solid #2563eb; padding-bottom: 10px; margin-bottom: 25px;">📋 Registros Detalhados com Evidências</h2>
            
            ${records.map((record, index) => `
                <div class="record-item ${index > 0 ? 'page-break' : ''}">
                    <div class="record-header">
                        <div class="record-id">${record.id}</div>
                        <div class="record-date">${record.date}</div>
                    </div>
                    
                    <div class="record-info">
                        <div class="info-card">
                            <div class="card-label">Código do Produto</div>
                            <div class="card-value">
                                <span class="product-code">${record.productCode}</span>
                            </div>
                        </div>
                        
                        <div class="info-card">
                            <div class="card-label">Descrição do Item</div>
                            <div class="card-value">${record.productDescription}</div>
                        </div>
                        
                        <div class="info-card">
                            <div class="card-label">Quantidade Afetada</div>
                            <div class="card-value"><strong>${record.quantity} unidades</strong></div>
                        </div>
                        
                        <div class="info-card">
                            <div class="card-label">Procedência</div>
                            <div class="card-value">
                                <span class="badge badge-${record.origin}">
                                    ${record.origin.charAt(0).toUpperCase() + record.origin.slice(1)}
                                </span>
                                ${record.supplierName ? `<br><div style="margin-top: 8px; color: #374151;"><strong>Fornecedor:</strong> ${record.supplierName}</div>` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <div class="defect-description">
                        <div class="defect-title">Descrição do Defeito:</div>
                        <div>${record.defectCause}</div>
                    </div>
                    
                    ${record.images && record.images.length > 0 ? `
                        <div class="images-section">
                            <div class="images-title">📷 Evidências Fotográficas (${record.images.length} ${record.images.length === 1 ? 'imagem' : 'imagens'}):</div>
                            <div class="images-grid">
                                ${record.images.map((img, imgIndex) => `
                                    <div class="image-container">
                                        <img src="${img}" class="defect-image" alt="Evidência ${imgIndex + 1} do defeito ${record.id}">
                                        <div class="image-caption">Evidência ${imgIndex + 1}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : `
                        <div class="images-section">
                            <div class="images-title">📷 Evidências Fotográficas:</div>
                            <div class="no-images">Nenhuma imagem anexada para este registro</div>
                        </div>
                    `}
                </div>
            `).join('')}
        </div>
    </div>

    <div class="footer">
        <p><strong>Relatório gerado automaticamente pelo Sistema de Controle de Não Conformidades</strong></p>
        <p>© 2024 - Sistema de Gestão da Qualidade | Documento confidencial</p>
        <p><em>Este relatório contém ${records.reduce((total, record) => total + (record.images ? record.images.length : 0), 0)} evidências fotográficas anexadas</em></p>
    </div>
</body>
</html>
            `;
        }

        function confirmClearRecords() {
            if (records.length === 0) {
                alert('Não há registros para limpar!');
                return;
            }
            confirmModal.style.display = 'block';
        }

        function closeConfirmModal() {
            confirmModal.style.display = 'none';
        }

        function clearAllRecords() {
            records = [];
            renderRecords();
            closeConfirmModal();
            showNotification('✅ Todos os registros foram limpos!', 'success');
        }

        function openImageModal(imageSrc) {
            imageModal.style.display = 'block';
            modalImage.src = imageSrc;
            
            if (isTouchDevice()) {
                let scale = 1;
                let startDistance = 0;
                
                modalImage.addEventListener('touchstart', function(e) {
                    if (e.touches.length === 2) {
                        startDistance = getDistance(e.touches[0], e.touches[1]);
                    }
                });
                
                modalImage.addEventListener('touchmove', function(e) {
                    if (e.touches.length === 2) {
                        e.preventDefault();
                        const currentDistance = getDistance(e.touches[0], e.touches[1]);
                        const newScale = scale * (currentDistance / startDistance);
                        
                        if (newScale >= 0.5 && newScale <= 3) {
                            modalImage.style.transform = `scale(${newScale})`;
                        }
                    }
                });
                
                modalImage.addEventListener('touchend', function(e) {
                    if (e.touches.length < 2) {
                        scale = parseFloat(modalImage.style.transform.replace('scale(', '').replace(')', '')) || 1;
                    }
                });
                
                function getDistance(touch1, touch2) {
                    return Math.sqrt(
                        Math.pow(touch2.clientX - touch1.clientX, 2) +
                        Math.pow(touch2.clientY - touch1.clientY, 2)
                    );
                }
            }
        }

        function closeImageModal() {
            imageModal.style.display = 'none';
            if (modalImage) {
                modalImage.style.transform = 'scale(1)';
            }
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.padding = '1rem 1.5rem';
            notification.style.borderRadius = '8px';
            notification.style.color = 'white';
            notification.style.fontWeight = '600';
            notification.style.zIndex = '9999';
            notification.style.animation = 'slideIn 0.3s ease';
            
            switch(type) {
                case 'success':
                    notification.style.background = '#10b981';
                    break;
                case 'info':
                    notification.style.background = '#3b82f6';
                    break;
                default:
                    notification.style.background = '#6b7280';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Event listeners para modal
        confirmModal.addEventListener('click', function(e) {
            if (e.target === confirmModal) {
                closeConfirmModal();
            }
        });

        imageModal.addEventListener('click', function(e) {
            if (e.target === imageModal) {
                closeImageModal();
            }
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeConfirmModal();
                closeImageModal();
            }
        });

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            // Otimizações para mobile
            if (isTouchDevice()) {
                // Adiciona classe para dispositivos touch
                document.body.classList.add('touch-device');
                
                // Melhora a responsividade dos inputs em iOS
                const inputs = document.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    input.addEventListener('focus', function() {
                        // Scroll suave para o campo em foco
                        setTimeout(() => {
                            this.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 300);
                    });
                });
                
                // Previne zoom em inputs (importante para iOS)
                const metaViewport = document.querySelector('meta[name="viewport"]');
                if (metaViewport) {
                    metaViewport.setAttribute('content', 
                        'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no'
                    );
                }
            }
            
            // Adiciona suporte a swipe para navegação entre tabs em mobile
            if (window.innerWidth <= 768) {
                let startX = 0;
                let startY = 0;
                const tabContent = document.querySelector('.tab-content');
                
                tabContent.addEventListener('touchstart', function(e) {
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                }, { passive: true });
                
                tabContent.addEventListener('touchend', function(e) {
                    const endX = e.changedTouches[0].clientX;
                    const endY = e.changedTouches[0].clientY;
                    const diffX = startX - endX;
                    const diffY = startY - endY;
                    
                    // Só processa swipe horizontal
                    if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                        const activeTab = document.querySelector('.tab-button.active');
                        const tabs = Array.from(document.querySelectorAll('.tab-button'));
                        const currentIndex = tabs.indexOf(activeTab);
                        
                        if (diffX > 0 && currentIndex < tabs.length - 1) {
                            // Swipe left - próxima tab
                            tabs[currentIndex + 1].click();
                        } else if (diffX < 0 && currentIndex > 0) {
                            // Swipe right - tab anterior  
                            tabs[currentIndex - 1].click();
                        }
                    }
                }, { passive: true });
            }
            
            // Inicialização normal
            setTimeout(() => {
                renderRecords();
            }, 100);
        });

        // Função para otimizar performance em mobile
        function optimizeForMobile() {
            if (window.innerWidth <= 768) {
                // Debounce para inputs em mobile
                const inputs = document.querySelectorAll('input[type="text"], textarea');
                inputs.forEach(input => {
                    let timeout;
                    input.addEventListener('input', function(e) {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => {
                            // Processa input após delay
                            e.target.dispatchEvent(new Event('debouncedInput'));
                        }, 300);
                    });
                });
                
                // Lazy loading para imagens
                const images = document.querySelectorAll('img[loading="lazy"]');
                if ('IntersectionObserver' in window) {
                    const imageObserver = new IntersectionObserver((entries, observer) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                const img = entry.target;
                                img.style.opacity = '1';
                                observer.unobserve(img);
                            }
                        });
                    });
                    
                    images.forEach(img => imageObserver.observe(img));
                }
            }
        }

        // Chama otimizações quando a página carrega
        window.addEventListener('load', optimizeForMobile);

        // Reotimiza quando a orientação muda
        window.addEventListener('orientationchange', function() {
            setTimeout(optimizeForMobile, 500);
        });
    </script>
</body>
</html>
